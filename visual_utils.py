import torch 
import transformers
from transformers import TrainerCallback
from torch.utils.data import Dataset
from peft import LoraConfig, get_peft_model, prepare_model_for_int8_training, PeftModel
import wandb
import sys
wandb.init(mode="disabled")
sys.path.append('..')
import utils
from dataclasses import dataclass, field
from typing import Dict, Optional, Sequence
from transformers.models.llama.modeling_llama import LlamaAttention,LlamaMLP
from transformers.models.opt.modeling_opt import OPTAttention
import numpy as np 
from sklearn.manifold import TSNE
from sklearn.decomposition import PCA
# // Set access token (NB: Keep this private!)
access_token = next(open('huggingface_token.txt')).strip()

def extract_feature(model, alignment_dataloader ):
    hidden_embedding_all = []
    # Your custom logic to accumulate embeddings and labels
    def get_leaf_modules_with_grad(module):
        module_list= []
        index= 0
        for name, module in module.named_modules():
            if isinstance(module,LlamaAttention) or isinstance(module, OPTAttention):
                module_list+= [module]
        # # print(module_list)
        return module_list
    
    def track_embedding_hook(original_embedding):
        def hook(module, input, output):
            mean_output = torch.mean(output[0].detach().to("cpu"), dim=1)
            # print(mean_output.shape)
            original_embedding.append(mean_output.view(-1))
            torch.cuda.empty_cache()
            return output
        return hook


    def apply_track_drift_hooks_recursive(module, hook_fn, hooks):
        hook = module.register_forward_hook(hook_fn)
        hooks.append(hook)
        
        
    for index, batch in enumerate(alignment_dataloader):
        original_embedding = []
        hooks = []
        leaf_modules_with_grad = get_leaf_modules_with_grad(model)
        for layer in leaf_modules_with_grad:
            apply_track_drift_hooks_recursive(layer, track_embedding_hook(original_embedding), hooks)
        inputs = batch["input_ids"]
        # here need to track hidden embedding 
        model(inputs) 
        original_embedding = torch.cat(original_embedding)
        hidden_embedding_all+=[original_embedding]
    # hidden_embedding_all = torch.cat(hidden_embedding_all)
    return hidden_embedding_all
    

def visual_test_tsne():
    embedded_features = torch.tensor(
[
[1.1881717443466187, -2.8653290271759033],
[-0.2895709276199341, -3.2499194145202637],
[0.5795971751213074, -1.711848497390747],
[0.7464707493782043, -3.1340208053588867],
[0.23848384618759155, -2.671001672744751],
[-0.4764130711555481, -1.703110933303833],
[0.3940029740333557, -2.851940631866455],
[0.2338116616010666, -2.2742056846618652],
[0.25558218359947205, -2.2837793827056885],
[0.5621721148490906, -2.0795974731445312],
[0.3596549332141876, -2.5883309841156006],
[1.7016723155975342, -2.2198355197906494],
[0.8633209466934204, -1.7075817584991455],
[-0.3219437897205353, -2.6774368286132812],
[-0.23504051566123962, -2.53483510017395],
[0.26595205068588257, -1.7890645265579224],
[0.34877362847328186, -2.388015031814575],
[0.6495696902275085, -2.168841600418091],
[0.6332988142967224, -2.853651523590088],
[1.6523483991622925, 2.7018909454345703],
[-5.074849605560303, 3.4344229698181152],
[-1.612225890159607, 1.0464720726013184],
[-1.2378815412521362, 3.1606285572052],
[-1.4765585660934448, -0.9323194622993469],
[-1.169206142425537, 1.8819868564605713],
[-2.455031394958496, 4.16696834564209],
[-0.129905104637146, 4.765899658203125],
[-2.324697494506836, 3.1017751693725586],
[-1.6152994632720947, 5.749273777008057],
[-1.3543870449066162, 6.863775730133057],
[-3.0748393535614014, -0.9872375726699829],
[-1.2646546363830566, 2.6685092449188232],
[0.2508011758327484, 3.7000749111175537],
[-0.45106741786003113, 2.8864524364471436],
[-2.3051273822784424, 5.730960845947266],
[-2.897008180618286, 5.271464824676514],
[-1.7222259044647217, 3.6218738555908203],
[-4.607392311096191, 2.199869394302368],
[-4.899765968322754, 4.919599533081055],
[-3.174906015396118, 3.820286273956299],
[1.9679089784622192, 4.190635681152344],
[-0.38175156712532043, 2.3329861164093018],
[1.6849372386932373, 1.369346261024475],
[-3.6381542682647705, 4.722388744354248],
[-3.3596112728118896, 1.0537774562835693],
[-0.9637871980667114, 4.111330032348633],
[-1.2565172910690308, 3.2720184326171875],
[-1.012725591659546, 2.7449610233306885],
[-1.8067693710327148, 4.405990123748779],
[-2.674070358276367, 0.3958952724933624],
[-3.9947330951690674, 3.90537166595459],
[1.0843757390975952, 4.892481327056885],
[-2.824131965637207, 2.9786312580108643],
[0.5862744450569153, 2.555546760559082],
[-3.789625883102417, 0.5348455309867859],
[-1.3712859153747559, 4.043979167938232],
[-0.44983503222465515, 2.4746415615081787],
[-2.3057563304901123, 0.5525224208831787],
[-0.4428922235965729, 1.416385293006897],
[-3.6573808193206787, 2.2797484397888184],
[-1.753121018409729, 2.3772528171539307],
[0.8115493655204773, 2.53953218460083],
[-0.2413017302751541, 3.9640955924987793],
[0.09715648740530014, 0.4021935760974884],
[-1.1277568340301514, 4.03196382522583],
[-1.748776912689209, 4.380752086639404],
[0.08170843869447708, 1.586728572845459],
[-2.904519557952881, 2.440001964569092],
[-2.400908946990967, 2.3896095752716064],
[-1.7792869806289673, 1.3523610830307007],
[-3.8898890018463135, 2.8599460124969482],
[-2.643707275390625, 4.170528888702393],
[-2.006918430328369, 4.9542555809021],
[-4.750052452087402, 1.1109360456466675],
[1.4349662065505981, 1.4291107654571533],
[-2.092593193054199, 4.5120530128479],
[0.34295743703842163, 3.7285354137420654],
[-2.1167290210723877, 6.59788703918457],
[-1.7836707830429077, 5.947380542755127],
[2.01163911819458, 4.193193435668945],
[-3.008115768432617, 2.433229684829712],
[-1.9790456295013428, 1.9922932386398315],
[-1.0007961988449097, 2.0737578868865967],
[-0.6426888108253479, 4.959178447723389],
[0.6089287996292114, 3.8294098377227783],
[-0.5517699718475342, 3.7843899726867676],
[-2.2496304512023926, 6.402725696563721],
[-2.6264891624450684, 1.6612178087234497],
[-0.5715094208717346, 2.3040592670440674],
[0.18010704219341278, 5.6742706298828125],
[-1.4739171266555786, 3.4482266902923584],
[-1.7226827144622803, 5.960819244384766],
[0.6880537867546082, 1.532845139503479],
[-0.9857288599014282, 0.8233761787414551],
[-2.253652572631836, 4.059020519256592],
[-1.491363286972046, -0.4881037473678589],
[-3.6847944259643555, 1.71921968460083],
[-3.69521164894104, 6.224756240844727],
[-1.2152221202850342, -0.021445997059345245],
]
)
    embedded_features2=(
    [
[4.430748462677002, 3.480051279067993],
[7.609931945800781, 7.77993106842041],
[5.201371669769287, 8.470314025878906],
[6.550191402435303, 7.91821813583374],
[-0.6245110034942627, 2.0697546005249023],
[4.578084945678711, 5.530022621154785],
[8.300976753234863, 6.75171422958374],
[2.8789305686950684, 5.7069315910339355],
[3.8572404384613037, 2.1442134380340576],
[3.8721232414245605, 5.670151710510254],
[5.634113788604736, 5.234874725341797],
[5.509939670562744, 6.048546314239502],
[2.3523576259613037, 2.0383098125457764],
[-1.1479626893997192, -0.028176873922348022],
[3.788649082183838, 6.516289234161377],
[4.393967151641846, 6.1521992683410645],
[4.7092790603637695, 1.1101293563842773],
[4.9839959144592285, 7.119512557983398],
[5.362376689910889, 4.013986587524414],
[2.748239278793335, 0.2760220766067505],
[2.432769536972046, 2.8010499477386475],
[5.831839561462402, 7.4832024574279785],
[5.582369804382324, 2.5848300457000732],
[7.43481969833374, 4.051338195800781],
[3.1894917488098145, 7.398988246917725],
[5.394584655761719, 6.100302219390869],
[6.001084804534912, 6.533693313598633],
[0.4683864414691925, 1.7232446670532227],
[3.523280620574951, 1.7167779207229614],
[6.716439723968506, 6.523588180541992],
[1.2453439235687256, -5.850710868835449],
[-1.7054933309555054, 1.3784657716751099],
[-1.678069829940796, -2.7439043521881104],
[-10.424654006958008, -3.321253538131714],
[0.10843552649021149, -2.4906980991363525],
[-7.759681701660156, -5.3589019775390625],
[-5.610403060913086, -5.529313087463379],
[-8.740340232849121, -2.1710517406463623],
[-3.466562032699585, -3.657742738723755],
[-3.6120479106903076, -4.924632549285889],
[-1.410955786705017, -5.443458557128906],
[-7.163392066955566, -1.1511378288269043],
[-7.06697940826416, -3.015939950942993],
[-5.175905704498291, -1.3134934902191162],
[-3.6229965686798096, -7.7732343673706055],
[-6.519857406616211, -6.186451435089111],
[-7.519000053405762, -6.951457500457764],
[-5.914412975311279, -4.326770782470703],
[-2.91678524017334, -2.04543137550354],
[-5.886613368988037, -9.428125381469727],
[-4.93688440322876, -4.457871913909912],
[-6.6079864501953125, -4.790950298309326],
[-5.403144836425781, -7.179194450378418],
[-6.121304988861084, 1.5699254274368286],
[-5.936529159545898, -2.5615768432617188],
[-3.614267110824585, -2.1725032329559326],
[-4.892968654632568, -2.8356361389160156],
[-10.047253608703613, -4.693547248840332],
[-7.951555252075195, -3.850830316543579],
[-4.423839569091797, -5.782402992248535],
[4.215395927429199, 3.2111759185791016],
[7.7700886726379395, 1.4449255466461182],
[1.0642646551132202, 4.24886417388916],
[7.283614635467529, 2.348874092102051],
[6.770014762878418, 0.4557048976421356],
[3.2629036903381348, 3.7506394386291504],
[8.964482307434082, 6.239258766174316],
[1.8084179162979126, 5.227137088775635],
[3.900585174560547, 1.1059832572937012],
[0.9742677211761475, 3.6634249687194824],
[5.9271345138549805, 4.673486232757568],
[6.773677349090576, 4.939159393310547],
[2.399557113647461, 4.30380392074585],
[-0.4147442877292633, 0.5378258228302002],
[8.865830421447754, 3.5260584354400635],
[3.151360273361206, 4.459110260009766],
[5.1494927406311035, 1.1611440181732178],
[4.729094505310059, 7.149033546447754],
[5.783745288848877, 3.7074193954467773],
[2.7350170612335205, 0.16703543066978455],
[2.895029067993164, 2.9950695037841797],
[-3.3604583740234375, -0.32690125703811646],
[6.242156982421875, 2.480600357055664],
[7.108899116516113, 3.264450788497925],
[2.0011017322540283, 7.494682788848877],
[4.577198028564453, 4.494329452514648],
[7.323079586029053, 6.376257419586182],
[0.669110894203186, 1.7396632432937622],
[5.937636375427246, 1.2948029041290283],
[7.216236114501953, 5.548685073852539],
[1.2341132164001465, -5.842806816101074],
[-0.43950873613357544, -3.946784734725952],
[-1.8195537328720093, -2.7174715995788574],
[-10.263181686401367, -3.2418181896209717],
[7.722372055053711, 0.23766979575157166],
[-7.795729637145996, -5.236489295959473],
[-5.613412380218506, -5.456090450286865],
[-8.7072172164917, -2.1899051666259766],
[-3.520946979522705, -3.7758092880249023],
[-3.0464277267456055, -4.978016376495361],
[-1.594168782234192, -5.394240856170654],
[-7.086797714233398, -1.3971949815750122],
[-6.803648471832275, -3.335268020629883],
[-5.142834663391113, -1.200358510017395],
[-2.946660280227661, -8.223697662353516],
[-2.6369521617889404, -6.356489181518555],
[-7.6828718185424805, -7.3956170082092285],
[-5.8415422439575195, -4.336129665374756],
[-1.7528730630874634, -3.490919351577759],
[-5.8752641677856445, -9.45623779296875],
[-4.884698390960693, -4.236012935638428],
[-6.775960445404053, -4.826771259307861],
[-5.417239189147949, -7.154965877532959],
[-6.12803316116333, 1.568689227104187],
[-5.84510612487793, -3.2698163986206055],
[9.441269874572754, 1.7398054599761963],
[-4.819936752319336, -3.025611162185669],
[-9.655557632446289, -5.224545001983643],
[-7.8079376220703125, -3.879196882247925],
[-4.24588680267334, -5.879980087280273],
]
    )
    
   
    # print(len(embedded_features))
    # print(embedded_features)
    # print(embedded_features.shape)
    
    import matplotlib.pyplot as plt
    
    
    colors = ['red', 'blue', 'green', 'purple', 'orange']
    # Add jitter to the points
    jitter_strength = 0.01  # Adjust the strength of the jitter
    np.random.seed(0)
    jitter = np.random.normal(scale=jitter_strength, size=embedded_features.shape)
    jittered_features = embedded_features +jitter
    jittered_features2 = embedded_features2 +jitter
    
    
    
    # Create a figure with two subplots
    fig, axes = plt.subplots(1, 2, figsize=(12, 6))

    # First subplot
    axes[0].scatter(jittered_features[:30, 0], jittered_features[:30, 1], c=colors[0], label="Before prune (gsm8k)", alpha=0.5)
    axes[0].scatter(jittered_features[60:90, 0], jittered_features[60:90, 1], c=colors[2], label="After prune (gsm8k)", alpha=0.5)
    axes[0].scatter(jittered_features[30:60, 0], jittered_features[30:60, 1], c=colors[1], label="Before prune (harmful data)", alpha=0.5)
    axes[0].scatter(jittered_features[90:120, 0], jittered_features[90:120, 1], c=colors[3], label="After prune (harmful data)", alpha=0.5)
    axes[0].legend(fontsize=12)
    axes[0].set_title('Before prune vs. After prune (Antidote)', fontsize=15)
    axes[0].set_xticks([])
    axes[0].set_yticks([])

    # Second subplot (You can modify this with different data or visualization)
    # Second subplot (New Data)
    axes[1].scatter(jittered_features2[:30, 0], jittered_features2[:30, 1], c=colors[0], label="Before prune (gsm8k)", alpha=0.5)
    axes[1].scatter(jittered_features2[60:90, 0], jittered_features2[60:90, 1], c=colors[2], label="After prune (gsm8k)", alpha=0.5)
    axes[1].scatter(jittered_features2[30:60, 0], jittered_features2[30:60, 1], c=colors[1], label="Before prune (harmful data)", alpha=0.5)
    axes[1].scatter(jittered_features2[90:120, 0], jittered_features2[90:120, 1], c=colors[3], label="After prune (harmful data)", alpha=0.5)
    axes[1].legend(fontsize=12)
    axes[1].set_title('Before prune vs. After prune (Random Pruning)', fontsize=15)
    axes[1].set_xticks([])
    axes[1].set_yticks([])
    # plt.colorbar()
    plt.tight_layout()
    plt.savefig("tsne", dpi=600)


def visual_test_tsne2():
    
    embedded_features= torch.tensor(
[
[1.70195472240448, 0.4492846429347992],
[1.5645701885223389, 1.476244568824768],
[1.5776056051254272, 1.1340370178222656],
[0.8446903824806213, 0.05703483894467354],
[2.292633295059204, -0.39439502358436584],
[2.4155335426330566, 0.4369674623012543],
[1.0456479787826538, 0.45358970761299133],
[1.580512523651123, 0.9110105633735657],
[2.636168956756592, 0.3078758716583252],
[1.3523584604263306, -0.33060577511787415],
[1.637071132659912, 0.5073682069778442],
[1.2818652391433716, 0.29037779569625854],
[1.6913275718688965, 1.0210306644439697],
[2.808192729949951, 0.8416893482208252],
[1.6677920818328857, 0.40417900681495667],
[1.6283879280090332, -0.07830081880092621],
[1.2608007192611694, 0.5080459117889404],
[2.481492757797241, 1.5667928457260132],
[2.190274477005005, 0.7497171759605408],
[-4.264125823974609, -1.6111955642700195],
[-3.4483838081359863, 4.837414741516113],
[-4.505324840545654, 2.115717887878418],
[-3.1543729305267334, -0.6323323249816895],
[-3.568723201751709, 0.711945652961731],
[-2.0636281967163086, 4.266933441162109],
[-3.5235424041748047, -0.5170682668685913],
[-4.17624044418335, 1.2696259021759033],
[-6.03522253036499, -1.778115153312683],
[-4.480022430419922, 1.3365517854690552],
[-4.230299472808838, 2.828460693359375],
[-1.7608989477157593, 3.1359214782714844],
[-7.61219596862793, 2.71808123588562],
[-2.4500296115875244, 1.4844549894332886],
[-6.032024383544922, -0.5794849395751953],
[-2.2703418731689453, -1.1232291460037231],
[-5.8156867027282715, 0.9103558659553528],
[-2.1980578899383545, -3.2841978073120117],
[-4.883758544921875, 2.261704444885254],
[-3.6756458282470703, 1.209957242012024],
[-2.011044502258301, -1.3441506624221802],
[-3.8405559062957764, 1.6149901151657104],
[-5.37753963470459, 0.969091534614563],
[-2.7783050537109375, 1.0225470066070557],
[-3.5653927326202393, 3.175248146057129],
[-4.465795040130615, 1.2815182209014893],
[-4.874587059020996, 0.9375869631767273],
[-1.2025610208511353, 0.423259973526001],
[-6.137002944946289, -1.7079862356185913],
[-3.7805919647216797, 1.4477940797805786],
[-6.552529335021973, 3.5699925422668457],
[-2.866943120956421, 1.8166736364364624],
[-6.714378833770752, 0.9195024371147156],
[-3.6733944416046143, 2.384152889251709],
[-2.952130079269409, 0.7645542621612549],
[-6.323958396911621, 2.24429988861084],
[-3.684889316558838, 1.5851861238479614],
[-2.7269768714904785, 0.9924008846282959],
[-4.706372261047363, 4.932273864746094],
[-4.4049458503723145, 3.7278833389282227],
[-5.058164119720459, 0.3555369973182678],
[-3.5894315242767334, -2.8124032020568848],
[-5.068194389343262, 3.2892839908599854],
[-4.5009965896606445, 0.14642482995986938],
[-1.871368646621704, 1.0893350839614868],
[-5.7372283935546875, -2.597740650177002],
[-2.0505549907684326, 2.06048846244812],
[-0.707805335521698, 2.0494544506073],
[-3.7521555423736572, 2.0599968433380127],
[-5.2714924812316895, 1.8204206228256226],
[-3.0160412788391113, 2.698718309402466],
[-2.1100854873657227, -3.2164340019226074],
[-4.206106185913086, 0.7757495045661926],
[-2.224195718765259, 3.4875385761260986],
[-7.683784484863281, 2.743016004562378],
[-2.5970726013183594, -0.7851359844207764],
[-6.864030361175537, -0.10099418461322784],
[-3.5663015842437744, 1.1398532390594482],
[-7.875599384307861, 1.1197757720947266],
[-5.911013603210449, 1.7208555936813354],
[-2.304699420928955, -1.0863776206970215],
[-4.998623847961426, -1.6299898624420166],
[-3.2462003231048584, 3.4764912128448486],
[-2.051912784576416, 0.2700723707675934],
[-5.261260986328125, 3.6282975673675537],
[-2.4512505531311035, -3.4822239875793457],
[-4.289323806762695, -1.7678955793380737],
[-5.248488426208496, -0.6576328277587891],
[-5.524768829345703, 2.5616719722747803],
[-6.2450995445251465, 0.935519278049469],
[-5.684749126434326, -0.40259242057800293],
[-6.812775135040283, -0.14966800808906555],
[-4.476723670959473, -1.5300959348678589],
[-3.2709124088287354, -0.46109360456466675],
[-5.19394588470459, -0.6366472244262695],
[-2.431218147277832, -0.8901618123054504],
[-5.351691246032715, 1.633235216140747],
[-3.809286594390869, 0.5015457272529602],
[-1.1420198678970337, 3.0637712478637695],
[-5.1295366287231445, 1.231789231300354],
]
    )
    
    embedded_features2 = torch.tensor(
[
[0.015973398461937904, 2.6588551998138428],
[0.9572009444236755, 0.2576577067375183],
[0.14157050848007202, 0.6110889315605164],
[1.4225913286209106, 1.0607959032058716],
[1.3665999174118042, 3.8721609115600586],
[-0.5683737397193909, 3.9669623374938965],
[-0.4101259410381317, 1.8316078186035156],
[0.5116398334503174, 0.8931028842926025],
[-0.5001469254493713, 4.447030067443848],
[-1.9450327157974243, 1.770920991897583],
[-0.16449256241321564, 2.248652219772339],
[0.3855598270893097, 1.814234733581543],
[-0.019589588046073914, 1.1598200798034668],
[2.090468406677246, 3.264183521270752],
[0.11161769181489944, 2.738403558731079],
[-1.356389045715332, 2.647733449935913],
[0.38887423276901245, 2.189382791519165],
[-2.4548275470733643, 3.167544364929199],
[1.095988392829895, 2.8090195655822754],
[-1.523652195930481, 2.994054079055786],
[-0.7778819799423218, 1.0326201915740967],
[-0.3051699697971344, 2.808734655380249],
[0.3978249728679657, 0.7475237250328064],
[0.31103768944740295, 1.5882984399795532],
[0.8391232490539551, 3.397217273712158],
[0.7120531797409058, 2.847708225250244],
[-0.9435760974884033, 3.4850573539733887],
[-0.44779860973358154, 3.4953229427337646],
[-1.0413552522659302, 2.299811601638794],
[-1.3933098316192627, 1.1576995849609375],
[0.6345270276069641, 1.770366907119751],
[-1.3090072870254517, 2.1571874618530273],
[-0.293523371219635, 2.3533689975738525],
[0.5076278448104858, 0.9468396902084351],
[-1.1812041997909546, 0.9062728881835938],
[0.11059229075908661, 3.4358439445495605],
[2.0804154872894287, 2.259265422821045],
[-1.6211471557617188, 1.9002541303634644],
[0.762330174446106, 1.5455982685089111],
[0.38062188029289246, 3.9883229732513428],
[2.4391627311706543, 1.3217025995254517],
[1.755568504333496, 2.345831871032715],
[-0.12350483238697052, 0.12119056284427643],
[-1.866495966911316, 1.8730615377426147],
[-1.208010196685791, 2.1077287197113037],
[-0.7454200387001038, 1.03438138961792],
[0.33730506896972656, 3.0618233680725098],
[1.2428866624832153, 2.18432354927063],
[-1.5438097715377808, 2.200228452682495],
[-0.07587742060422897, 3.8439342975616455],
[-3.5006260871887207, -2.4380252361297607],
[-4.799468994140625, -5.9234299659729],
[-3.325695276260376, -4.418240547180176],
[-5.326125621795654, -2.452077627182007],
[-3.278792142868042, -3.7656848430633545],
[-1.5841739177703857, -2.029329776763916],
[-5.210447788238525, -2.4872360229492188],
[-4.1023173332214355, -3.400629758834839],
[-2.174589157104492, -4.953426361083984],
[-4.178225994110107, -2.878908634185791],
[-5.437880516052246, -3.84025239944458],
[-3.2553722858428955, -1.276231050491333],
[-5.300769329071045, -5.002995491027832],
[-2.79498291015625, -2.9487380981445312],
[-3.819383382797241, -2.085861921310425],
[-5.046725273132324, -1.23835289478302],
[-4.6289520263671875, -3.2506723403930664],
[-6.068867206573486, -1.592985987663269],
[-4.682895660400391, -2.5908455848693848],
[-3.65737247467041, -3.2521936893463135],
[-5.1035847663879395, -1.0378504991531372],
[-3.883312463760376, -3.2063097953796387],
[-4.727210521697998, -3.8386077880859375],
[-2.475972890853882, -3.4416251182556152],
[-6.066859245300293, -4.799851417541504],
[-4.262788772583008, -3.730494976043701],
[-4.311989784240723, -4.127920627593994],
[-2.5552752017974854, -1.6745636463165283],
[-2.0645649433135986, -4.956961154937744],
[-3.763526678085327, -3.378980875015259],
[-6.237805366516113, -3.7307307720184326],
[-2.8293206691741943, -2.781705856323242],
[-4.435683727264404, -1.915973424911499],
[-3.9607977867126465, -3.7822508811950684],
[-2.648550510406494, -3.7187016010284424],
[-5.080272197723389, -4.622032165527344],
[-3.6817660331726074, -3.396512746810913],
[-2.505434036254883, -3.449486494064331],
[-1.3648889064788818, -3.9113354682922363],
[-3.8378381729125977, -5.039849281311035],
[-4.427178382873535, -4.600784778594971],
[-6.381017208099365, -2.8116893768310547],
[-3.83034086227417, -4.282264709472656],
[-4.921599388122559, -3.4581243991851807],
[-1.740583896636963, -3.2789435386657715],
[-2.2056400775909424, -5.525479316711426],
[-3.437107563018799, -5.654426574707031],
[-3.4915194511413574, -0.3633025288581848],
[-3.938985824584961, -3.5004730224609375],
[-4.313891887664795, -2.530580997467041],
]
)
    print(len(embedded_features2))
    embedded_features3 = torch.tensor(
[
[0.9797242283821106, 2.4720656871795654],
[2.1736981868743896, -1.427048683166504],
[0.6376391053199768, -1.361673355102539],
[1.5709056854248047, 0.4595690369606018],
[2.6164255142211914, 3.73830509185791],
[-0.03871465474367142, 4.65455961227417],
[-0.28980404138565063, 0.936830461025238],
[1.2005325555801392, -0.9836448431015015],
[0.6099236607551575, 5.334325790405273],
[-3.4128305912017822, 1.3272533416748047],
[0.7035602331161499, 1.7586486339569092],
[1.191487431526184, 0.7306429743766785],
[1.3298437595367432, -1.646915078163147],
[3.9517152309417725, 3.900219202041626],
[1.154110074043274, 2.61114501953125],
[-1.8244125843048096, 1.911704182624817],
[-2.1222145557403564, 3.9977126121520996],
[-4.537871360778809, -0.3953858017921448],
[2.6988565921783447, 2.7896478176116943],
[-1.1427100896835327, 1.3837553262710571],
[-0.7548466920852661, -0.6013392210006714],
[0.28939923644065857, 2.690613031387329],
[0.9441024661064148, -1.0130560398101807],
[0.7857593894004822, 0.24453018605709076],
[2.0019071102142334, 3.294222116470337],
[2.1127262115478516, 2.220874786376953],
[-0.19514234364032745, 3.151618480682373],
[0.08129628002643585, 3.8071813583374023],
[-2.069028854370117, 1.4893461465835571],
[-2.319375991821289, -0.5424249172210693],
[2.1505346298217773, 0.7851290106773376],
[-2.0074408054351807, 0.6572003364562988],
[0.2687768042087555, 2.0095348358154297],
[0.6085244417190552, -0.29503682255744934],
[-1.5101799964904785, -0.6878997087478638],
[1.1756491661071777, 3.5406923294067383],
[3.7526135444641113, 1.9284555912017822],
[-2.998847484588623, 1.2149345874786377],
[2.0237817764282227, 0.23434193432331085],
[1.2732707262039185, 4.169973850250244],
[3.607207775115967, -1.6621289253234863],
[3.4331915378570557, 1.8724793195724487],
[-0.1860722154378891, -1.6893926858901978],
[-3.218658208847046, 1.4387733936309814],
[-2.2508983612060547, 1.1013057231903076],
[-0.7980650067329407, -0.5423203110694885],
[1.4681460857391357, 3.011229991912842],
[2.756305456161499, 1.4349273443222046],
[-3.307715654373169, 2.2650229930877686],
[0.6183417439460754, 4.073381423950195],
[2.838416337966919, -0.31512293219566345],
[-3.98337459564209, 1.2784349918365479],
[-3.738316774368286, 2.5466461181640625],
[1.9281736612319946, 2.158557415008545],
[1.0663092136383057, -1.171568751335144],
[0.34864482283592224, 1.3384112119674683],
[-0.48691850900650024, 1.9374680519104004],
[0.7612800002098083, 0.9911444187164307],
[-3.6233761310577393, 0.16239336133003235],
[2.051074743270874, 4.86238431930542],
[0.0028430819511413574, 0.592104434967041],
[0.3170121908187866, 2.792922019958496],
[-1.1225887537002563, 1.0732181072235107],
[-2.423978567123413, 2.6301028728485107],
[-2.420384168624878, 0.057442717254161835],
[-3.052664041519165, 0.5448015928268433],
[-1.437585711479187, 5.294047832489014],
[-1.4318634271621704, 3.1901001930236816],
[4.183527946472168, 0.1236850768327713],
[0.35559558868408203, -0.351093590259552],
[-1.6845351457595825, 2.6622233390808105],
[0.2936403155326843, 2.0468430519104004],
[-1.0622179508209229, 3.5604093074798584],
[-1.9616522789001465, -0.08034252375364304],
[2.358813762664795, -0.32168319821357727],
[-2.2013707160949707, 1.5798413753509521],
[4.078614234924316, 2.614698886871338],
[-2.4605305194854736, 0.7350683808326721],
[0.39281538128852844, 3.301306962966919],
[-1.6401487588882446, 0.4635903239250183],
[-1.2965987920761108, -5.729497909545898],
[-3.6333231925964355, -3.893648386001587],
[-2.2519259452819824, -4.09829044342041],
[-3.0216710567474365, -5.1689839363098145],
[-1.901116132736206, -5.037990570068359],
[-2.750431776046753, -3.050772190093994],
[-2.968282699584961, -5.337533950805664],
[-1.721838355064392, -4.715536594390869],
[-0.8337809443473816, -4.099822521209717],
[-1.6779707670211792, -4.638546943664551],
[-0.6871011853218079, -5.02248477935791],
[-1.6651756763458252, -2.9419021606445312],
[-0.37463295459747314, -5.736905097961426],
[-2.0018057823181152, -6.204117774963379],
[-1.357784390449524, -3.9562935829162598],
[-2.354430913925171, -4.72666072845459],
[-1.428030252456665, -4.985315799713135],
[0.02119794860482216, -4.376323223114014],
[-2.4617607593536377, -5.639893054962158],
[-1.781844973564148, -4.715489864349365],
]
)
   
    # print(len(embedded_features))
    # print(embedded_features)
    # print(embedded_features.shape)
    
    import matplotlib.pyplot as plt
    
    
    colors = ['red', 'blue', 'green', 'purple', 'orange']
    # Add jitter to the points
    jitter_strength = 0.01  # Adjust the strength of the jitter
    np.random.seed(0)
    jitter = np.random.normal(scale=jitter_strength, size=embedded_features.shape)
    jitter2  = np.random.normal(scale=jitter_strength, size=embedded_features2.shape)
    jitter3  = np.random.normal(scale=jitter_strength, size=embedded_features3.shape)
    jittered_features = embedded_features +jitter
    jittered_features2 = embedded_features2 +jitter2
    jittered_features3 = embedded_features3 +jitter3
    
    
    
    # Create a figure with two subplots
    fig, axes = plt.subplots(1, 3, figsize=(12, 4))

    # First subplot
    axes[2].scatter(jittered_features[:19, 0], jittered_features[:19, 1], c=colors[2], label="gsm8k", alpha=0.5)
    axes[2].scatter(jittered_features[20:, 0], jittered_features[20:, 1], c=colors[0], label="harmful sample", alpha=0.5)
    # axes[0].scatter(jittered_features[30:60, 0], jittered_features[30:60, 1], c=colors[1], label="Before prune (harmful data)", alpha=0.5)
    # axes[0].scatter(jittered_features[90:120, 0], jittered_features[90:120, 1], c=colors[3], label="After prune (harmful data)", alpha=0.5)
    axes[2].legend(fontsize=12)
    axes[2].set_title('Harmful ratio=80%', fontsize=15)
    axes[2].set_xticks([])
    axes[2].set_yticks([])

    
    


    # First subplot
    axes[1].scatter(jittered_features2[:50, 0], jittered_features2[:50, 1], c=colors[2], label="gsm8k", alpha=0.5)
    axes[1].scatter(jittered_features2[50:, 0], jittered_features2[50:, 1], c=colors[0], label="harmful sample", alpha=0.5)
    # axes[0].scatter(jittered_features[30:60, 0], jittered_features[30:60, 1], c=colors[1], label="Before prune (harmful data)", alpha=0.5)
    # axes[0].scatter(jittered_features[90:120, 0], jittered_features[90:120, 1], c=colors[3], label="After prune (harmful data)", alpha=0.5)
    axes[1].legend(fontsize=12)
    axes[1].set_title('Harmful ratio=50%', fontsize=15)
    axes[1].set_xticks([])
    axes[1].set_yticks([])

    # # Second subplot (You can modify this with different data or visualization)
    # # Second subplot (New Data)
    axes[0].scatter(jittered_features3[:80, 0], jittered_features3[:80, 1], c=colors[2], label="gsm8k", alpha=0.5)
    axes[0].scatter(jittered_features3[80:, 0], jittered_features3[80:, 1], c=colors[0], label="harmful sample", alpha=0.5)
    axes[0].legend(fontsize=12)
    axes[0].set_title('Harmful ratio=20%', fontsize=15)
    axes[0].set_xticks([])
    axes[0].set_yticks([])
    # plt.colorbar()
    plt.tight_layout()
    plt.savefig("tsne", dpi=600)
    
# visual_test_tsne()
visual_test_tsne2()